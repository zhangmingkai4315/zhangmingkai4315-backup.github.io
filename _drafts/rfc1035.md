## RFC 1035 域名实施及规范

### 1. RFC1035介绍

本篇RFC主要介绍域名系统和协议的实施细节， 并且假设读者已经掌握了RFC1034中关于DNS的相关概念。 域名系统本身是一个混合了多种功能和数据类型的系统，部分功能和实现仍旧处于实验阶段。 由于DNS的可扩展性，一些新的功能实现或者数据类型可能超出了官方协议的定义范围。 官方协议仅包含标准查询，响应以及Internet 资源记录类型格式， 部分定义在之前RFC给出的，可能已经过期，不在被使用。

> 本篇RFC中的部分实例仅用作教学使用，读者应谨慎使用


### 2. 简介

#### 2.1  背景回顾

域名系统目的是提供一种命名资源的机制，且系统本身应该兼容不同类型的主机，网络或者协议族。用户使用域名系统只需要通过本地的代理（解析器Resolver）发送特定的查询即可，整个的域名树形结构对用户来说是一个单一的信息空间， 解析器负责隐藏整个的分布式的数据结构，通过多次查询获得用户的数据。

对于解析器，整个的树形结构以及数据是分散在多个不同的域名服务器上的， 不同的域名空间存储在不同的服务器上（多台域名服务器可提供相同的解析服务）。 解析器本身需要至少一个域名服务器的配置（根服务器或其他内网的独立域服务器），才能开始整个的查询流程。解析器帮助处理多层的域名查询，以及错误处理，比如当单个域名服务器不可用的时候，重新发送新的查询到其他冗余的服务器上。

域名服务器管理两种数据， 第一种数据为区数据，这种数据是整体树形结构中的一部分子树的相关数据内容。这部分数据也属于权威数据，域名服务器周期性检查存放在本地的区数据文件或者其他的主服务器，一旦发生变化则复制一份新的数据并加载到内存中，等待查询。 另一种数据为缓存数据，数据可能不完整，只包含之前查询被缓存下来的，但是通过这种方式，可以提升整体的查询效率，数据本身根据TTL设置一定的到期时间，随着时间到期即在缓存中被删除。通过不同功能的切分，使得不同部分出现的问题得到很好的隔离，排查更加容易

#### 2.2 常规配置

下图为一个典型的DNS系统图，用户程序通过解析器向DNS权威服务器进行查询，并等待响应。解析器内部的缓存提供用户重复域名查询的直接响应。 同时解析器也可以不在同一台机器，而是作为一个开放式的递归服务器，提供多个用户同时查询使用。

```

                 Local Host                        |  Foreign
                                                   |
    +---------+               +----------+         |  +--------+
    |         | user queries  |          |queries  |  |        |
    |  User   |-------------->|          |---------|->|Foreign |
    | Program |               | Resolver |         |  |  Name  |
    |         |<--------------|          |<--------|--| Server |
    |         | user responses|          |responses|  |        |
    +---------+               +----------+         |  +--------+
                                |     A            |
                cache additions |     | references |
                                V     |            |
                              +----------+         |
                              |  cache   |         |
                              +----------+         |
```

域名服务器通过读取权威数据提供本区域名的查询服务，并接收解析器的查询，同时域名服务器要求冗余配置，因此至少有一台主服务器，一台二级服务器，二级服务器通过查询SOA进行比较，如果发现数据发生变化则执行区传送完成数据的更新

下图代表了一个具有二级服务器的配置图:

                 Local Host                        |  Foreign
                                                   |
      +---------+                                  |
     /         /|                                  |
    +---------+ |             +----------+         |  +--------+
    |         | |             |          |responses|  |        |
    |         | |             |   Name   |---------|->|Foreign |
    |  Master |-------------->|  Server  |         |  |Resolver|
    |  files  | |             |          |<--------|--|        |
    |         |/              |          | queries |  +--------+
    +---------+               +----------+         |
                                A     |maintenance |  +--------+
                                |     +------------|->|        |
                                |      queries     |  |Foreign |
                                |                  |  |  Name  |
                                +------------------|--| Server |
                             maintenance responses |  +--------+

有时候查询服务可将缓存集中起来管理，建立中央缓存数据中心来减少分散的缓存服务。配置如下图所示, 其中StubResolver是一个可以看做系统上的简单的DNS查询接口，发送查询到递归服务器并等待服务器器响应。


                   Local Hosts                     |  Foreign
                                                   |
    +---------+                                    |
    |         | responses                          |
    | Stub    |<--------------------+              |
    | Resolver|                     |              |
    |         |----------------+    |              |
    +---------+ recursive      |    |              |
                queries        |    |              |
                               V    |              |
    +---------+ recursive     +----------+         |  +--------+
    |         | queries       |          |queries  |  |        |
    | Stub    |-------------->| Recursive|---------|->|Foreign |
    | Resolver|               | Server   |         |  |  Name  |
    |         |<--------------|          |<--------|--| Server |
    +---------+ responses     |          |responses|  |        |
                              +----------+         |  +--------+
                              |  Central |         |
                              |   cache  |         |
                              +----------+         |


#### 2.3 规范

域名系统有很多已经形成的规范来处理底层和基础的问题， 尽管具体实施人员可以自由打破这些约束，但是应该理解这些规范，这对于与其他主机沟通上至关重要。

##### 2.3.1 域名语法规范


域名组成中依赖下面的规则进行定义，其中域名包含多个label组成，不同label使用（.）进行隔离，每个label必须满足ARPANET主机名规则，字母开始，结束必须是字母或者数字，组成内容必须是字符，数字和-符号，长度必须小于等于63。 域名中大小写无关，因此域名仅仅字符的大小写拼写不同认为是相同的域名.

以下为域名定义规范说明， 该定义充分考虑了不同应用的约束，并防止出现任何的字符问题。

```
<domain> ::= <subdomain> | " "

<subdomain> ::= <label> | <subdomain> "." <label>

<label> ::= <letter> [ [ <ldh-str> ] <let-dig> ]

<ldh-str> ::= <let-dig-hyp> | <let-dig-hyp> <ldh-str>

<let-dig-hyp> ::= <let-dig> | "-"

<let-dig> ::= <letter> | <digit>

<letter> ::= any one of the 52 alphabetic characters A through Z in
upper case and a through z in lower case

<digit> ::= any one of the ten digits 0 through 9

```

##### 2.3.2 数据传输顺序

DNS包数据传输的顺序按照八位组的方式进行处理，当一个数据包展示一组组八位组的时候，传输这些数据按照正常的读写顺序进行，例如下面图展示的多个八位组，顺序如描述的顺序123456进行：

```
     0                   1
     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |       1       |       2       |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |       3       |       4       |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
    |       5       |       6       |
    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

```

在一个8位组里面，读写的顺序是按照高阶序进行，也就是下面的存储值为十进制的170

```
     0 1 2 3 4 5 6 7
    +-+-+-+-+-+-+-+-+
    |1 0 1 0 1 0 1 0|
    +-+-+-+-+-+-+-+-+

```

##### 2.3.3 字符约定

DNS域名是不区分大小写的，任何域名具有相同的字符但是不同的大小写，将被认为是一样的域名。因此数据 x.y 和 X.Y将被存储在相同的位置，并且任何时候只有一个会被保留下来，比较查询的时候也按照不区分大小写进行比较，内部统一使用强制一致的标准完成（统一大写或者小写的方式处理）。


#### 2.3.4 大小限制

- 标签：          0-63个字符
- 名称：           255字符
- TTL :             32字节的有符号正整数
- UDP消息：   512字节 

### 3. 域名空间和RR定义

#### 3.1 域名空间定义


域名在消息存储的时候使用一系列的标签组成，每一个标签使用一个8位代表标签的长度后面紧跟的是组成标签的多个8位组。由于每一个域名最后都是以为null的根标签作为结尾，因此后面跟的是一个0（一个字节长度）代表结束符号，由于每个标签长度不能超过63，因此每个代表长度的字节位的8位中前两位均为0，总长度被限制到255个字符长度以内。

尽管每个标签字符可以是任何8位组成的值，但是为了兼容性，还是尽量需要满足之前定义的规范来命名，字符比较的时候，字符要按照大小写不敏感的方式进行比较，其他的字符比如数字和-应该按照精确匹配完成。


#### 3.2 RR定义
#####  3.2.1 格式

所有的资源记录具有相同的格式如下图所示，其中的RDLENGTH代表了整个的RDATA(实际指定类型的数据)的长度， RDATA的格式按照类型和类别不同而不同



```
                                    1  1  1  1  1  1
      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                                               |
    /                                               /
    /                      NAME                     /
    |                                               |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                      TYPE                     |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                     CLASS                     |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                      TTL                      |
    |                                               |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
    |                   RDLENGTH                    |
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--|
    /                     RDATA                     /
    /                                               /
    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

#### 3.2.2 查询类型

下表列举的是服务器可以接收的查询类型列表，其中中间的数字代表实际存储在字段中的值，使用不同的值来区分不同类型。

```

A               1 主机地址

NS              2 权威服务器

MD              3 邮件目的地址 (Obsolete - use MX)

MF              4 邮件中转器地址 (Obsolete - use MX)

CNAME           5 域名别名

SOA             6 作为权威区数据的起始资源类型

MB              7 邮箱域名 (EXPERIMENTAL)

MG              8 邮件组成员(EXPERIMENTAL)

MR              9 邮件重命名域名 (EXPERIMENTAL)

NULL            10 Null资源记录 (EXPERIMENTAL)

WKS             11 已知的服务描述

PTR             12  域名指针

HINFO           13 主机信息

MINFO           14 邮件或邮件列表信息

MX              15 邮件交换地址

TXT             16 文本符号

```

#### 3.2.3 查询类型集合

除了以上的类型...


